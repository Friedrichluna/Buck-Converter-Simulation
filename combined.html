<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buck Converter Simulation</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
	<div>
        <label for="automatic_mode">Automatic-Mode: </label>
        <input type="checkbox" id="automatic_mode" checked>
    </div>
    <canvas id="cirquit_canvas" width="800" height="400"></canvas>
    <div>
        <label for="currentInput">Current (A): </label>
        <input type="number" id="currentInput" value="1" step="0.1">
        <label for="voltageInput">Voltage (V): </label>
        <input type="number" id="voltageInput" value="5" step="0.1">
    </div>
    <div id="coordinates">Coordinates: (0, 0)</div>
    <canvas id="plot" width="800" height="600"></canvas>
    <script>
        //----------------------------Differenzialgleichung---------------------------------
        // Parameter
        const V_in = 20; // Eingangsspannung in Volt
        const L = 99e-3; // Induktivität in Henry
        const C = 1e-3; // Kapazität in Farad
        const R_load = 10; // Lastwiderstand in Ohm
        const f = 100e3; // Schaltfrequenz in Hz
        const T = 1 / f; // Schaltperiode in Sekunden
        const dt = 1e-4; // Zeitschritt
		
        // Initialbedingungen
        let i_L = 0; // Anfangsstrom durch die Induktivität
		let i_C = 0; //Kondensatorstrom
        let v_C = 0; // Anfangsspannung über den Kondensator
        let q = 1; // Initialer Schaltzustand (geschlossen)
        let stopSimulation = false; // Flag to stop the simulation
        let breakSimulation = false; // Flag to break the simulation
		let counter = 0;
        let automatic_mode = true; // Automatic mode flag

        // Canvas setup
        const plot_canvas = document.getElementById('plot');
        const ctx = plot_canvas.getContext('2d');

        let t_total = 0; // Gesamtzeit
        const t_data = [];
        const iL_data = [];
        const vC_data = [];
        const q_data = [];

        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                q = 1 - q; // Schaltzustand wechseln
            } else if (event.key === 's') {
                stopSimulation = true; // Stoppen der Simulation
            } else if (event.key === 'b') {
                breakSimulation = !breakSimulation; // Pausieren und Fortsetzen der Simulation
            }
        });


        function draw_plot() {
            ctx.clearRect(0, 0, plot_canvas.width, plot_canvas.height);

            const margin = 50;
            const graphWidth = plot_canvas.width - 2 * margin;
            const graphHeight = (plot_canvas.height - 4 * margin) / 3;

            // Helper function to plot a graph
            function plotGraph(data, title, yLabel, yMin, yMax, yOffset) {
                ctx.beginPath();
                ctx.moveTo(margin, plot_canvas.height - margin - yOffset);

                data.forEach((point, index) => {
                    const x = margin + (graphWidth * index) / (data.length - 1);
                    const y = plot_canvas.height - margin - yOffset - ((graphHeight * (point - yMin)) / (yMax - yMin));
                    ctx.lineTo(x, y);
                });

                ctx.stroke();

                // Draw labels and title
                ctx.fillText(title, margin, plot_canvas.height - margin - yOffset - graphHeight - 10);
                ctx.fillText(yLabel, 10, plot_canvas.height - margin - yOffset - graphHeight / 2);
            }

            plotGraph(q_data, 'Schaltzustand q(t)', 'Zustand (0 oder 1)', 0, 1, 0);
            plotGraph(iL_data, 'Spulenstrom i_L(t)', 'Strom (A)', Math.min(...iL_data), Math.max(...iL_data), graphHeight + margin);
            plotGraph(vC_data, 'Kondensatorspannung v_C(t)', 'Spannung (V)', Math.min(...vC_data), Math.max(...vC_data), 2 * (graphHeight + margin));
        }

        function simulate() {
            if (stopSimulation) return;

            if (!breakSimulation) {
                if (automatic_mode) { //swithces q automaticcally
                    if (counter > 30){ 
                        q = 1-q; 
                        counter = 0;
                    }
                    counter = counter+1;
                }
				

                const di_L_dt = (V_in * q - v_C) / L;
                const dv_C_dt = (i_L - v_C / R_load) / C;
                // Euler-Verfahren zur Lösung der DGLs
				i_L += di_L_dt * dt;
                v_C += dv_C_dt * dt;
				if (i_L < 0){ //spulenstrom kann nicht kleiner als 0 werden, wegen Diode
					i_L = 0;
				}
				i_C = C*dv_C_dt
				
                // Gesamtzeit aktualisieren
                t_total += dt;

                // Daten speichern
                t_data.push(t_total);
                iL_data.push(i_L);
                vC_data.push(v_C);
                q_data.push(q);
            }
            draw_plot();
        }
        //-----------------------------------Schaltungssimulation--------------------------------------------------------
		// Initialize canvas and context
        const cirquit_canvas = document.getElementById('cirquit_canvas');
        const ctx2 = cirquit_canvas.getContext('2d');

        // Current and voltage (default values)
        let spulenStrom = 0; // In Amperes
		let kondensatorStrom = 0; // In Amperes
        let voltage = 1; // In Volts

        class Wire{
            constructor(startX, startY, endX, endY,knots){
                this.startX = startX;
                this.startY = startY;
                this.endX = endX;
                this.endY = endY;
                this.knots = knots;
            }
            
            // Function to draw a wire
            drawWire() {
                ctx2.beginPath();
                ctx2.lineWidth = 5;
                ctx2.moveTo(this.startX, this.startY);
                ctx2.lineTo(this.endX, this.endY);
                ctx2.strokeStyle = 'black';
                ctx2.stroke();
            }
            drawWire_(startX,startY,endX,endY) {
                ctx2.beginPath();
                ctx2.lineWidth = 5;
                ctx2.moveTo(startX, startY);
                ctx2.lineTo(endX, endY);
                ctx2.strokeStyle = 'black';
                ctx2.stroke();
            }
            // Distance between dots is inversely proportional to voltage
            getDotSpacing(voltage) {
                return 50 / voltage;
            }
            // Function to draw the moving dots along a wire
            drawDots = function (){
                let dotRadius = 3;
                let dotColor = 'yellow';
                let integralCurrent = 0;
                return function (current, voltage) {
                    const dotSpacing = this.getDotSpacing(voltage);
                    integralCurrent += current;
                    integralCurrent = integralCurrent/voltage;
                    const dotSpeed = integralCurrent; // Speed of the dots, proportional to current
                    const time = Date.now() / 1000; // Get current time in seconds

                    const dx = this.endX - this.startX;
                    const dy = this.endY - this.startY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx);

                    for (let d = (dotSpeed) % dotSpacing; d < distance; d += dotSpacing) {
                        
                        const x = this.startX + Math.cos(angle) * d;
                        const y = this.startY + Math.sin(angle) * d;
                        if (d>0.1){
                            ctx2.beginPath();
                            ctx2.arc(x, y, dotRadius, 0, 2 * Math.PI);
                            ctx2.fillStyle = dotColor;
                            ctx2.fill();
                        }
                    }
                }
            }()
            drawKnot(x, y) {
                const knotRadius = 5;
                ctx2.beginPath();
                ctx2.arc(x, y, knotRadius, 0, 2 * Math.PI);
                ctx2.fillStyle = 'black';
                ctx2.fill();
            }
            // Function to create a wire with moving dots
            createWire(current, voltage) {
                this.drawWire();
                this.drawDots(current, voltage);
                if (this.knots){
                    this.drawKnot(this.startX, this.startY);
                    this.drawKnot(this.endX, this.endY);
                }
            }
        }
        function createDiode(startX, startY) {
            diode = new Wire(startX-25, startY, startX+25, startY);
            diode.drawWire_(startX-25, startY, startX+25, startY); //horizontal
            diode.drawWire_(startX-25, startY+50, startX, startY);
            diode.drawWire_(startX+25, startY+50, startX, startY);
            diode.drawWire_(startX-25, startY+50, startX+25, startY+50);
        }

        function drawMagneticField(startX, startY, endX, endY, scalingFactor) {
            ctx2.beginPath();
            ctx2.lineWidth = 1;
            ctx2.strokeStyle = 'blue';

            const loops = 5; // Number of loops in the inductor
            const totalLength = endX - startX;
            const loopSpacing = totalLength / (loops * 2); // Space for each half loop

            let currentX = startX;
            scalingFactor = scalingFactor*2

            for (let i = 0; i < loops; i++) {
                // Draw magnetic field lines around each loop
                for (let j = 1; j <= scalingFactor; j++) {
                    const offset = j * loopSpacing / (scalingFactor + 1);
                    // Top part of the loop
                    ctx2.moveTo(currentX + offset, startY - loopSpacing);
                    ctx2.bezierCurveTo(
                        currentX + offset - loopSpacing, startY - loopSpacing * 2, 
                        currentX + offset + loopSpacing, startY - loopSpacing * 2, 
                        currentX + offset + loopSpacing, startY - loopSpacing
                    );
                }
                currentX += loopSpacing * 2;
            }

            ctx2.stroke();
        }

        function drawInductor(startX, startY, endX, endY,current) {
            ctx2.beginPath();
            ctx2.lineWidth = 5;
            ctx2.strokeStyle = 'black';

            const loops = 5; // Number of loops in the inductor
            const totalLength = endX - startX;
            const loopSpacing = totalLength / (loops * 2); // Space for each half loop

            let currentX = startX;
            for (let i = 0; i < loops; i++) {
                // Draw the uper half of the loop
                ctx2.arc(currentX + loopSpacing, startY, loopSpacing, Math.PI, 0, false);
                currentX += loopSpacing * 2;
                
            }

            ctx2.stroke();
            drawMagneticField(startX, startY, endX, endY, current);
        }
        function createSwitch(startX,startY,state, current, voltage){
            if(state){
                
                shiftY = 0;
                shiftX = 0;
                knots = true;
            }
            else{
                shiftY = 30;
                shiftX = 5;
                knots = false;
            }
            mySwitch = new Wire(startX, startY, startX+50-shiftX, startY-shiftY, knots);
            mySwitch.createWire(current, voltage);

        }
        
        function createCapacitor(startX, startY, current, highVoltage, lowVoltage){
            upLeft = new Wire(startX-25,startY,startX,startY, false)
            upLeft.createWire(current,highVoltage);
            upRight = new Wire(startX+25,startY,startX,startY, false)
            upRight.createWire(current,highVoltage);
            downLeft = new Wire(startX-25,startY+50,startX,startY+50, false)
            downLeft.createWire(current,lowVoltage);
            downRight = new Wire(startX+25,startY+50,startX,startY+50, false)
            downRight.createWire(current,lowVoltage);
        }
        function createResistor(startX, startY){
            up = new Wire(startX-15,startY,startX+15,startY, false)
            up.createWire(0,0);
            right = new Wire(startX+15,startY,startX+15,startY+70, false)
            right.createWire(0,0);
            right = new Wire(startX-15,startY,startX-15,startY+70, false)
            right.createWire(0,0);
            up = new Wire(startX-15,startY+70,startX+15,startY+70, false)
            up.createWire(0,0);
        }
        // Update function to redraw all wires and dots
        wire1 = new Wire(50, 50, 100, 50, true);
        wire2 = new Wire(150, 50, 250, 50, true);
        wire3 = new Wire(50, 350, 50, 50, true);
        wire4 = new Wire(250, 350, 50, 350, true);
        //Diodenstrang
        wire5 = new Wire(250, 150, 250, 50, true);
        wire6 = new Wire(250, 350, 250, 150, true);
        //createDiode()
        //
        
        //Kondensatorstrang
        wire8 = new Wire(450, 150, 450, 50, false);
        wire15 = new Wire(450,200,450,350,false);
        //Spulenstrang
        wire9 = new Wire(250, 50, 320, 50, true);
        wire10 = new Wire(400, 50, 450, 50, true);
        wire11 = new Wire(450, 50, 550, 50, true);
        //drawinductor()
        wire7 = new Wire(450, 50, 550, 50, true);
        wire12 = new Wire(550, 350, 450, 350, true);
        wire13 = new Wire(550, 50, 550, 150, true);
        wire16 = new Wire(550, 220, 550, 350, true);
        wire14 = new Wire(450, 350, 250, 350, true);

        function update() {
            ctx2.clearRect(0, 0, cirquit_canvas.width, cirquit_canvas.height); // Clear canvas
			const conversion_factor = 2;
			spulenStrom = i_L*conversion_factor;
			kondensatorStrom = i_C*conversion_factor;
			lastStrom = spulenStrom - kondensatorStrom;
			let kondensatorSpanung = voltage + v_C/2;
            //console.log(spulenStrom); //debug
            //Schalterstrang
            createSwitch(100,50,q, spulenStrom*q, voltage);
            //
            wire1.createWire(spulenStrom*q, voltage);
            wire2.createWire(spulenStrom*q, voltage); // oben links
            wire3.createWire(spulenStrom*q, voltage); // links links
            wire4.createWire(spulenStrom*q, voltage); // unten links
            //Diosenstrang
            wire5.createWire(spulenStrom*(1-q), voltage); // oben
            wire6.createWire(spulenStrom*(1-q), voltage); // unten
            createDiode(250, 150);
            //
			
            //Kondensatorstrang
			wire8.createWire(-kondensatorStrom, voltage); // mitte rechts
            wire15.createWire(kondensatorStrom, voltage);
            createCapacitor(450, 150, kondensatorStrom, kondensatorSpanung, 0);
            //Spulenstrang
			wire9.createWire(spulenStrom, voltage); // oben mitte
            wire10.createWire(spulenStrom, voltage); // oben mitte
            wire14.createWire(spulenStrom, voltage); // unten mitte
            drawInductor(320, 50, 400, 50, spulenStrom);
            //Laststrang
            createResistor(550, 150);
            wire7.createWire(lastStrom, voltage); // unten mitte
			wire12.createWire(lastStrom, voltage); // Last oben
            wire16.createWire(lastStrom, voltage); // Last oben
			wire13.createWire(lastStrom, voltage); // Last oben
			

            
			
			simulate();
            requestAnimationFrame(update);
        }

        // Display cursor coordinates
        cirquit_canvas.addEventListener('mousemove', function(e) {
            const rect = cirquit_canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            document.getElementById('coordinates').textContent = `Coordinates: (${x.toFixed(2)}, ${y.toFixed(2)})`;
        });
       
        // Set up event listeners for input changes
        document.getElementById('automatic_mode').addEventListener('input', function(e) {
            automatic_mode = e.target.checked;
        });

        document.getElementById('currentInput').addEventListener('input', function(e) {
            current = parseFloat(e.target.value);
        });

        document.getElementById('voltageInput').addEventListener('input', function(e) {
            voltage = parseFloat(e.target.value);
        });


        update(); // Start the animation loop
    </script>
</body>
</html>
